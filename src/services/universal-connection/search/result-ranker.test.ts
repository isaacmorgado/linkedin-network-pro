/**
 * Result Ranker Tests
 * Comprehensive test suite for search result ranking algorithm
 */

import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import {
  rankResults,
  rankResultsWithWeights,
  getScoreBreakdown,
  type RankingWeights,
} from './result-ranker';
import { networkDB, clearAllData } from '@/lib/storage/network-db';
import type { SearchQuery, SearchResult } from '@/types/search';
import type { ActivityEvent } from '@/types/network';

// ============================================================================
// TEST DATA
// ============================================================================

const mockResults: SearchResult[] = [
  {
    profileId: 'profile-1',
    name: 'Jane Smith',
    headline: 'Senior Software Engineer at Google',
    company: 'Google',
    role: 'Senior Software Engineer',
    connectionDegree: 1,
    matchScore: 0, // Will be calculated by ranker
    pathAvailable: true,
    reasoning: '', // Will be generated by ranker
  },
  {
    profileId: 'profile-2',
    name: 'John Doe',
    headline: 'Product Manager at Netflix',
    company: 'Netflix',
    role: 'Product Manager',
    connectionDegree: 2,
    matchScore: 0,
    pathAvailable: true,
    reasoning: '',
  },
  {
    profileId: 'profile-3',
    name: 'Alice Johnson',
    headline: 'HR Manager at Netflix',
    company: 'Netflix',
    role: 'HR Manager',
    connectionDegree: 2,
    matchScore: 0,
    pathAvailable: true,
    reasoning: '',
  },
  {
    profileId: 'profile-4',
    name: 'Bob Wilson',
    headline: 'Engineer',
    company: undefined,
    role: undefined,
    connectionDegree: 3,
    matchScore: 0,
    pathAvailable: false,
    reasoning: '',
  },
  {
    profileId: 'profile-5',
    name: 'Carol Martinez',
    headline: undefined,
    company: undefined,
    role: undefined,
    connectionDegree: 3,
    matchScore: 0,
    pathAvailable: false,
    reasoning: '',
  },
];

const mockActivities: ActivityEvent[] = [
  {
    id: 'activity-1',
    actorId: 'profile-1',
    targetId: 'someone',
    type: 'comment',
    timestamp: new Date().toISOString(), // Recent
    scrapedAt: new Date().toISOString(),
  },
  {
    id: 'activity-2',
    actorId: 'profile-1',
    targetId: 'someone',
    type: 'reaction',
    timestamp: new Date().toISOString(), // Recent
    scrapedAt: new Date().toISOString(),
  },
  {
    id: 'activity-3',
    actorId: 'profile-2',
    targetId: 'someone',
    type: 'comment',
    timestamp: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString(), // 60 days ago
    scrapedAt: new Date().toISOString(),
  },
];

// ============================================================================
// SETUP & TEARDOWN
// ============================================================================

beforeEach(async () => {
  await clearAllData();
  await networkDB.activities.bulkAdd(mockActivities);
});

afterEach(async () => {
  await clearAllData();
});

// ============================================================================
// BASIC RANKING TESTS
// ============================================================================

describe('rankResults - Basic Functionality', () => {
  it('should rank all results', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    expect(ranked.length).toBe(5);
    expect(ranked.every((r) => r.matchScore > 0)).toBe(true);
  });

  it('should sort results by match score descending', async () => {
    const query: SearchQuery = { query: 'engineer', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    for (let i = 1; i < ranked.length; i++) {
      const prev = ranked[i - 1]!;
      const curr = ranked[i]!;

      if (prev.matchScore === curr.matchScore) {
        // If scores equal, should be sorted by degree (lower = better)
        expect(prev.connectionDegree).toBeLessThanOrEqual(curr.connectionDegree);
      } else {
        // Otherwise sorted by score (higher = better)
        expect(prev.matchScore).toBeGreaterThan(curr.matchScore);
      }
    }
  });

  it('should add reasoning to each result', async () => {
    const query: SearchQuery = { query: 'engineer', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    expect(ranked.every((r) => r.reasoning.length > 0)).toBe(true);
  });

  it('should preserve original result data', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    // Check first result preserves data
    const original = mockResults[0]!;
    const found = ranked.find((r) => r.profileId === original.profileId)!;

    expect(found.name).toBe(original.name);
    expect(found.headline).toBe(original.headline);
    expect(found.company).toBe(original.company);
    expect(found.connectionDegree).toBe(original.connectionDegree);
  });
});

// ============================================================================
// CONNECTION DEGREE SCORING
// ============================================================================

describe('rankResults - Connection Degree Scoring', () => {
  it('should rank 1st degree higher than 2nd degree', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const firstDegree = ranked.find((r) => r.connectionDegree === 1)!;
    const secondDegree = ranked.find((r) => r.connectionDegree === 2)!;

    expect(firstDegree.matchScore).toBeGreaterThan(secondDegree.matchScore);
  });

  it('should rank 2nd degree higher than 3rd degree', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const secondDegree = ranked.find((r) => r.connectionDegree === 2)!;
    const thirdDegree = ranked.find((r) => r.connectionDegree === 3)!;

    expect(secondDegree.matchScore).toBeGreaterThan(thirdDegree.matchScore);
  });

  it('should include connection degree in reasoning', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const firstDegree = ranked.find((r) => r.connectionDegree === 1)!;
    expect(firstDegree.reasoning).toContain('direct connection');

    const secondDegree = ranked.find((r) => r.connectionDegree === 2)!;
    expect(secondDegree.reasoning).toContain('2nd-degree');

    const thirdDegree = ranked.find((r) => r.connectionDegree === 3)!;
    expect(thirdDegree.reasoning).toContain('3rd-degree');
  });
});

// ============================================================================
// KEYWORD MATCHING SCORING
// ============================================================================

describe('rankResults - Keyword Matching', () => {
  it('should boost score for name matches', async () => {
    const query: SearchQuery = { query: 'Jane Smith', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const janeResult = ranked.find((r) => r.name === 'Jane Smith')!;
    expect(janeResult.matchScore).toBeGreaterThan(50);
    expect(janeResult.reasoning).toContain('name matches');
  });

  it('should boost score for headline matches', async () => {
    const query: SearchQuery = { query: 'Product Manager', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const pmResult = ranked.find((r) => r.name === 'John Doe')!;
    expect(pmResult.reasoning).toContain('headline matches');
  });

  it('should boost score for company matches', async () => {
    const query: SearchQuery = { query: 'Netflix', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const netflixResults = ranked.filter((r) => r.company === 'Netflix');
    expect(netflixResults.length).toBe(2);
    netflixResults.forEach((result) => {
      expect(result.reasoning).toContain('Netflix');
    });
  });

  it('should handle multi-keyword queries', async () => {
    const query: SearchQuery = { query: 'HR Manager Netflix', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const aliceResult = ranked.find((r) => r.name === 'Alice Johnson')!;
    expect(aliceResult.matchScore).toBeGreaterThan(60);
  });

  it('should handle empty queries', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    expect(ranked.every((r) => r.matchScore > 0)).toBe(true);
  });
});

// ============================================================================
// PROFILE COMPLETENESS SCORING
// ============================================================================

describe('rankResults - Profile Completeness', () => {
  it('should rank complete profiles higher', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    // Jane has complete profile (all fields)
    const completeProfile = ranked.find((r) => r.profileId === 'profile-1')!;
    // Carol has minimal profile (only name)
    const minimalProfile = ranked.find((r) => r.profileId === 'profile-5')!;

    expect(completeProfile.matchScore).toBeGreaterThan(minimalProfile.matchScore);
  });

  it('should boost score for profiles with headlines', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const withHeadline = ranked.find((r) => r.profileId === 'profile-1')!;
    const withoutHeadline = ranked.find((r) => r.profileId === 'profile-5')!;

    // Assuming same connection degree, profile with headline should rank higher
    if (withHeadline.connectionDegree === withoutHeadline.connectionDegree) {
      expect(withHeadline.matchScore).toBeGreaterThan(withoutHeadline.matchScore);
    }
  });

  it('should boost score for profiles with company', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const withCompany = ranked.find((r) => r.profileId === 'profile-1')!;
// @ts-expect-error - Used for comparison in commented assertions
    const __withoutCompany = ranked.find((r) => r.profileId === 'profile-4')!;

    // Profile with company should have completeness reasoning
    expect(withCompany.reasoning).toContain('complete profile');
  });

  it('should consider path availability', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    const withPath = ranked.find((r) => r.pathAvailable === true)!;
    expect(withPath.reasoning).toContain('path available');
  });
});

// ============================================================================
// ACTIVITY SCORING
// ============================================================================

describe('rankResults - Activity Scoring', () => {
  it('should boost score for users with recent activity', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    // Profile-1 has recent activities
    const activeUser = ranked.find((r) => r.profileId === 'profile-1')!;
    // Profile-3 has no activities
// @ts-expect-error - Used for comparison in commented assertions
    const __inactiveUser = ranked.find((r) => r.profileId === 'profile-3')!;

    // Active user should mention activity in reasoning
    expect(activeUser.reasoning).toContain('active user');
  });

  it('should not penalize users without activity data', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults(mockResults, query);

    // All results should have positive scores
    expect(ranked.every((r) => r.matchScore > 0)).toBe(true);
  });
});

// ============================================================================
// FILTER-BASED REASONING
// ============================================================================

describe('rankResults - Filter-based Reasoning', () => {
  it('should include company filter in reasoning', async () => {
    const query: SearchQuery = {
      query: '',
      filters: { company: 'Netflix' },
    };
    const ranked = await rankResults(mockResults, query);

    const netflixResults = ranked.filter((r) => r.company === 'Netflix');
    netflixResults.forEach((result) => {
      expect(result.reasoning).toContain('at Netflix');
    });
  });

  it('should include location filter in reasoning', async () => {
    const query: SearchQuery = {
      query: '',
      filters: { location: 'San Francisco' },
    };
    const ranked = await rankResults(mockResults, query);

    // All results should mention location in reasoning
    ranked.forEach((result) => {
      expect(result.reasoning).toContain('San Francisco');
    });
  });

  it('should include role filter in reasoning', async () => {
    const query: SearchQuery = {
      query: '',
      filters: { role: 'senior' },
    };
    const ranked = await rankResults(mockResults, query);

    // Results with senior role should mention it
    const seniorResult = ranked.find((r) => r.role?.toLowerCase().includes('senior'));
    if (seniorResult) {
      expect(seniorResult.reasoning).toContain('senior');
    }
  });
});

// ============================================================================
// CUSTOM WEIGHTS
// ============================================================================

describe('rankResultsWithWeights - Custom Weighting', () => {
  it('should allow custom weights', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const customWeights: RankingWeights = {
      connection: 0.6, // Emphasize connection degree more
      keyword: 0.2,
      completeness: 0.1,
      activity: 0.1,
    };

    const ranked = await rankResultsWithWeights(mockResults, query, customWeights);

    // 1st degree connection should rank very high with these weights
    const firstDegree = ranked.find((r) => r.connectionDegree === 1)!;
    expect(firstDegree.matchScore).toBeGreaterThan(70);
  });

  it('should emphasize keywords with high keyword weight', async () => {
    const query: SearchQuery = { query: 'engineer', filters: undefined };
    const keywordHeavyWeights: RankingWeights = {
      connection: 0.1,
      keyword: 0.7, // Emphasize keywords
      completeness: 0.1,
      activity: 0.1,
    };

    const ranked = await rankResultsWithWeights(mockResults, query, keywordHeavyWeights);

    // Results matching "engineer" should rank higher
    const engineerResults = ranked.filter((r) =>
      r.headline?.toLowerCase().includes('engineer')
    );
    expect(engineerResults.length).toBeGreaterThan(0);
  });
});

// ============================================================================
// SCORE BREAKDOWN
// ============================================================================

describe('getScoreBreakdown', () => {
  it('should return detailed score breakdown', async () => {
    const query: SearchQuery = { query: 'engineer', filters: undefined };
    const result = mockResults[0]!;

    const breakdown = await getScoreBreakdown(result, query);

    expect(breakdown).toHaveProperty('total');
    expect(breakdown).toHaveProperty('connectionWeight');
    expect(breakdown).toHaveProperty('keywordWeight');
    expect(breakdown).toHaveProperty('completenessWeight');
    expect(breakdown).toHaveProperty('activityWeight');

    expect(breakdown.total).toBeGreaterThan(0);
    expect(breakdown.total).toBeLessThanOrEqual(100);
  });

  it('should have weights between 0-100', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const result = mockResults[0]!;

    const breakdown = await getScoreBreakdown(result, query);

    expect(breakdown.connectionWeight).toBeGreaterThanOrEqual(0);
    expect(breakdown.connectionWeight).toBeLessThanOrEqual(100);
    expect(breakdown.keywordWeight).toBeGreaterThanOrEqual(0);
    expect(breakdown.keywordWeight).toBeLessThanOrEqual(100);
    expect(breakdown.completenessWeight).toBeGreaterThanOrEqual(0);
    expect(breakdown.completenessWeight).toBeLessThanOrEqual(100);
    expect(breakdown.activityWeight).toBeGreaterThanOrEqual(0);
    expect(breakdown.activityWeight).toBeLessThanOrEqual(100);
  });
});

// ============================================================================
// EDGE CASES
// ============================================================================

describe('rankResults - Edge Cases', () => {
  it('should handle empty results array', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults([], query);

    expect(ranked).toEqual([]);
  });

  it('should handle single result', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const ranked = await rankResults([mockResults[0]!], query);

    expect(ranked.length).toBe(1);
    expect(ranked[0]!.matchScore).toBeGreaterThan(0);
  });

  it('should handle results with missing optional fields', async () => {
    const query: SearchQuery = { query: '', filters: undefined };
    const minimalResult: SearchResult = {
      profileId: 'minimal',
      name: 'Minimal User',
      headline: undefined,
      company: undefined,
      role: undefined,
      connectionDegree: 2,
      matchScore: 0,
      pathAvailable: false,
      reasoning: '',
    };

    const ranked = await rankResults([minimalResult], query);

    expect(ranked[0]!.matchScore).toBeGreaterThan(0);
    expect(ranked[0]!.reasoning.length).toBeGreaterThan(0);
  });
});

// ============================================================================
// INTEGRATION TESTS
// ============================================================================

describe('rankResults - Integration', () => {
  it('should produce consistent rankings', async () => {
    const query: SearchQuery = { query: 'engineer', filters: undefined };

    // Rank twice
    const ranked1 = await rankResults(mockResults, query);
    const ranked2 = await rankResults(mockResults, query);

    // Results should be identical
    expect(ranked1.length).toBe(ranked2.length);
    for (let i = 0; i < ranked1.length; i++) {
      expect(ranked1[i]!.profileId).toBe(ranked2[i]!.profileId);
      expect(ranked1[i]!.matchScore).toBe(ranked2[i]!.matchScore);
    }
  });

  it('should handle complex multi-filter query', async () => {
    const query: SearchQuery = {
      query: 'manager',
      filters: {
        company: 'Netflix',
        role: 'manager',
      },
    };

    const ranked = await rankResults(mockResults, query);

    // Alice (HR Manager at Netflix) should rank highly
    const aliceResult = ranked.find((r) => r.name === 'Alice Johnson')!;
    expect(aliceResult.matchScore).toBeGreaterThan(60);
    expect(aliceResult.reasoning).toContain('Netflix');
    expect(aliceResult.reasoning).toContain('manager');
  });
});
